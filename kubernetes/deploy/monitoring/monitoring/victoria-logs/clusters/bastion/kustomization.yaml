apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- persistence.yaml

helmCharts:
  - name: victoria-logs-single
    repo: https://victoriametrics.github.io/helm-charts/
    version: 0.6.4
    releaseName: &app victoria-logs
    includeCRDs: true
    valuesInline:
      server:
        enabled: true
        image:
          repository: docker.io/victoriametrics/victoria-logs
          tag: "v0.32.0-victorialogs@sha256:b9b4658691c5e4b1db6b1006b0dc9209c691d5b918d29428b4b936c1689aeec1"
          pullPolicy: IfNotPresent
        retentionPeriod: 1 # months
        persistentVolume:
          enabled: true
          existingClaim: victoria-logs-data
          subPath: data
        ingress:
          enabled: true
          ingressClassName: tailscale
          pathType: Prefix
          hosts:
            - name: &host vmlogs
              path: /
              port: http
          tls:
            - hosts: [*host]
        resources: # TODO: tune
          requests:
            cpu: 10m
            memory: 512Mi
          limits:
            cpu: 3000m
            memory: 4Gi
        securityContext:
          enabled: true
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: [ALL] }
        podSecurityContext:
          enabled: true
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
          fsGroupChangePolicy: Always
          seccompProfile: { type: "RuntimeDefault" }
        statefulSet:
          enabled: false
        serviceMonitor:
          enabled: true
        affinity: {}
      fluent-bit:
        enabled: false
      extraObjects: []
      global:
        nameOverride: *app
        victoriaLogs:
          server:
            fullnameOverride: *app
