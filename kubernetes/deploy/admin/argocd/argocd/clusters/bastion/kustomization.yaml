apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd

resources:
- github.com/argoproj/argo-cd//manifests/ha/cluster-install?ref=v2.10.0
- default-project.yaml
- infra-repo.yaml
- bastion-cluster-config.yaml
- github-oauth-client.yaml

components:
- ../../components/prometheus-operator
- ../../components/tailscale-ingress
# - ../../components/github-app-repo-creds

patches:
- patch: |
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: argocd-redis-ha-proxy-network-policy
    spec:
      ingress:
      - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
        ports:
        - protocol: TCP
          port: 9101
  target:
    kind: NetworkPolicy
    name: argocd-redis-ha-proxy-network-policy
- path: argocd-cm.yaml
- path: argocd-rbac-cm.yaml
- path: argocd-cmd-params-cm.yaml
- path: patch-resources.yaml
