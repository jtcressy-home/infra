apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- externalsecret.yaml

helmCharts:
- name: app-template
  repo: https://bjw-s.github.io/helm-charts/
  version: 2.2.0
  releaseName: wyze-bridge
  valuesInline:
    controllers:
      main:
        containers:
          main:
            image:
              repository: mrlt8/wyze-bridge
              # tag: 2.6.0-qsv
              tag: 2.6.0
            
            env:
              TZ: America/Chicago
              # H264_ENC: h264_qsv
              NET_MODE: LAN
              ON_DEMAND: False
              SUBSTREAM: True
              # LIBVA_DRIVER_NAME: i965
            envFrom:
              - secretRef:
                  name: wyze-secret
            securityContext:
              privileged: true
            resources:
              requests:
                cpu: 1000m
                memory: 500M
                # gpu.intel.com/i915: 1
              limits:
                memory: 2000M
                # gpu.intel.com/i915: 1
          proxy-kitchen-cam: &unifi-cam-proxy
            env:
              - name: CAMERA_NAME
                value: kitchen-cam
              - name: RANDOM_MAC
                value: C4:7E:66:9F:1A:2A
              - name: CERT_PATH
                value: /unifi-cam-proxy/client.pem
              - name: TZ
                value: America/Chicago
              - name: NVR_HOST
                valueFrom:
                  secretKeyRef:
                    name: unifi-cam-proxy
                    key: NVR_HOST
              - name: ADOPTION_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: unifi-cam-proxy
                    key: ADOPTION_TOKEN
            command:
              - unifi-cam-proxy
              - --host=$(NVR_HOST)
              - --mac=$(RANDOM_MAC)
              - --cert=$(CERT_PATH)
              - --token=$(ADOPTION_TOKEN)
              - rtsp
              - -s
              - rtsp://localhost:8554/$(CAMERA_NAME)
            image:
              repository: keshavdv/unifi-cam-proxy
              tag: latest
          proxy-office-cam:
            <<: *unifi-cam-proxy
            env:
              - name: CAMERA_NAME
                value: office-cam
              - name: RANDOM_MAC
                value: C4:7E:66:9F:1A:2B
            
        # pod:
        #   nodeSelector:
        #     intel.feature.node.kubernetes.io/gpu: "true"

    service:
      main:
        ports:
          http:
            enabled: true
            port: 5000
          rtmp:
            enabled: true
            port: 1935
          rtsp:
            enabled: true
            port: 8554
          hls:
            enabled: true
            port: 8888
          webrtc:
            enabled: true
            port: 8889
    
    persistence:
      unifi-cam-proxy:
        enabled: true
        type: secret
        name: unifi-cam-proxy
            