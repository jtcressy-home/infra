---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: n8n
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: n8n-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Chart expects this key name for externalPostgresql.existingSecret
        postgres-password: "{{ .N8N_POSTGRES_PASS }}"
        # n8n encryption key (referenced via existingEncryptionKeySecret)
        N8N_ENCRYPTION_KEY: "{{ .N8N_ENCRYPTION_KEY }}"
        # MCP bearer token (used by n8n workflow auth)
        N8N_MCP_BEARER_TOKEN: "{{ .N8N_MCP_BEARER_TOKEN }}"
        # Init container env vars for postgres-init
        INIT_POSTGRES_DBNAME: n8n
        INIT_POSTGRES_HOST: teslamate-db-rw.teslamate.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .N8N_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .N8N_POSTGRES_PASS }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        # OIDC client credentials (from tsidp registration, optional until configured)
        OIDC_CLIENT_ID: "{{ .OIDC_CLIENT_ID | default \"\" }}"
        OIDC_CLIENT_SECRET: "{{ .OIDC_CLIENT_SECRET | default \"\" }}"
        # Arr API keys (available to n8n via envFrom for workflow credentials)
        SONARR_API_KEY: "{{ .SONARR_API_KEY }}"
        RADARR_API_KEY: "{{ .RADARR_API_KEY }}"
        PROWLARR_API_KEY: "{{ .PROWLARR_API_KEY }}"
  dataFrom:
    - extract:
        key: cloudnative-pg
    - extract:
        key: n8n
    - extract:
        key: sonarr
    - extract:
        key: radarr
    - extract:
        key: prowlarr
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: n8n-restic
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: n8n-restic-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        RESTIC_REPOSITORY: "{{ .REPOSITORY_TEMPLATE }}/n8n"
        RESTIC_PASSWORD: "{{ .RESTIC_PASSWORD }}"
        AWS_ACCESS_KEY_ID: "{{ .AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ .AWS_SECRET_ACCESS_KEY }}"
  dataFrom:
    - extract:
        key: volsync-restic-template
