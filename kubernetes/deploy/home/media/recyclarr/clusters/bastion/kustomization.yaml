apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - externalsecret.yaml
  - persistence.yaml

configMapGenerator:
  - name: recyclarr-configmap
    files:
      - ./resources/recyclarr.yml
generatorOptions:
  disableNameSuffixHash: true

helmCharts:
  - name: app-template
    repo: https://bjw-s.github.io/helm-charts/
    version: 3.2.1
    releaseName: &app recyclarr
    valuesInline:
      controllers:
        recyclarr:
          type: cronjob
          cronjob:
            schedule: "@daily"
            timeZone: &timeZone America/Chicago
            concurrencyPolicy: Forbid
            successfulJobsHistory: 1
            failedJobsHistory: 1
          containers:
            app:
              image:
                repository: ghcr.io/recyclarr/recyclarr
                tag: 7.0.0@sha256:88d7ef8feb313398a98aafbc2966959f1689191864247f8be15572d5c67641d5
              args:
                - sync
              env:
                TZ: *timeZone
              envFrom:
                - secretRef:
                    name: recyclarr-secret
              resources:
                requests:
                  cpu: 10m
                limits:
                  memory: 128Mi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
      defaultPodOptions:
        securityContext:
          runAsNonRoot: true
          runAsUser: 568
          runAsGroup: 568
          fsGroup: 568
          fsGroupChangePolicy: OnRootMismatch
      persistence:
        config:
          existingClaim: *app
        config-file:
          type: configMap
          name: recyclarr-configmap
          globalMounts:
            - path: /config/recyclarr.yml
              subPath: recyclarr.yml
              readOnly: true