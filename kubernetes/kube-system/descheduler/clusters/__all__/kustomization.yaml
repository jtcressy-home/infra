apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../base

patches:
- target:
    kind: ConfigMap
    namespace: kube-system
    name: descheduler-policy-configmap
  patch: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: descheduler-policy-configmap
      namespace: kube-system
    data:
      policy.yaml: |
        apiVersion: descheduler/v1alpha2
        kind: DeschedulerPolicy
        profiles:
          - name: Default
            pluginConfig:
            - name: RemoveDuplicates
            - name: RemovePodsViolatingInterPodAntiAffinity
            - name: LowNodeUtilization
              args:
                thresholds:
                  "cpu": 20
                  "memory": 20
                  "pods": 20
                targetThresholds:
                  "cpu": 50
                  "memory": 50
                  "pods": 60
            - name: RemovePodsHavingTooManyRestarts
              args:
                podRestartThreshold: 100
                includingInitContainers: true
            - name: RemovePodsViolatingTopologySpreadConstraint
              args:
                includeSoftConstraints: false
            - name: RemovePodsViolatingNodeTaints
            - name: RemovePodsViolatingNodeAffinity
              args:
                nodeAffinityTypes:
                - requiredDuringSchedulingIgnoredDuringExecution
            plugins:
              deschedule:
                enabled:
                  - RemovePodsViolatingInterPodAntiAffinity
                  - RemovePodsHavingTooManyRestarts
                  - RemovePodsViolatingNodeTaints
                  - RemovePodsViolatingNodeAffinity
              balance:
                enabled:
                  - RemoveDuplicates
                  - LowNodeUtilization
                  - RemovePodsViolatingTopologySpreadConstraint