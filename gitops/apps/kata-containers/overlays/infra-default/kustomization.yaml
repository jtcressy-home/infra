apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../base
- nfd-rule-hwvirt.yaml

patches:
- target:
    group: apps
    version: v1
    kind: DaemonSet
    namespace: kube-system
    name: kata-deploy
  patch: |
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: kata-deploy
      namespace: kube-system
    spec:
      template:
        spec:
          nodeAffinity:
            requiredDuringSchedulingIgnoreDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: feature.node.kubernetes.io/hw-virt-enabled
                  operator: In
                  values:
                  - "true"
                - key: kubernetes.io/os
                  operator: In
                  values:
                  - "linux"
                - key: kuberntes.io/arch
                  operator: In
                  values:
                  - "amd64"
                  #- "arm64"
          containers:
          - name: kube-kata
            lifecycle:
              postStart:
                exec:
                  command:
                  - bash
                  - -c
                  - |
                    ln -s /etc/systemd/system/snap.microk8s.daemon-containerd.service /etc/systemd/system/containerd.service || true;
                    systemctl daemon-reload;
          volumes:
          - name: containerd-conf
            hostPath:
              name: /var/snap/microk8s/current/args/
          - name: local-bin
            hostPath:
              type: DirectoryOrCreate