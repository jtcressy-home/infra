apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- externalsecret.yaml

helmCharts:
- name: nri-bundle
  repo: https://helm-charts.newrelic.com
  version: 5.0.15
  releaseName: newrelic-bundle
  namespace: newrelic
  includeCRDs: true
  valuesInline:
    global:
      cluster: core
      lowDataMode: true
      customSecretName: newrelic
      customSecretKey: licenseKey
    newrelic-infrastructure:
      privileged: true
    kube-state-metrics:
      enabled: true
      image:
        tag: v2.7.0
    kubeEvents:
      enabled: true
    newrelic-prometheus-agent:
      enabled: true
      lowDataMode: true
      extraVolumes:
      - name: homeassistant-token
        secret:
          secretName: homeassistant-token
      extraVolumeMounts:
      - name: homeassistant-token
        mountPath: /var/run/secrets/hass.io
        readOnly: true
      verboseLog: false
      config:
        kubernetes:
          integrations_filter:
            enabled: false
        static_targets:
          jobs:
          - job_name: self-metrics
            skip_sharding: true  # sharding is skipped to obtain self-metrics from all Prometheus servers.
            targets:
              - "localhost:9090"
            extra_metric_relabel_config:
              - source_labels: [__name__]
                regex: "\
                  prometheus_agent_active_series|\
                  prometheus_target_interval_length_seconds|\
                  prometheus_target_scrape_pool_targets|\
                  prometheus_remote_storage_samples_pending|\
                  prometheus_remote_storage_samples_in_total|\
                  prometheus_remote_storage_samples_retried_total|\
                  prometheus_agent_corruptions_total|\
                  prometheus_remote_storage_shards|\
                  prometheus_sd_kubernetes_events_total|\
                  prometheus_agent_checkpoint_creations_failed_total|\
                  prometheus_agent_checkpoint_deletions_failed_total|\
                  prometheus_remote_storage_samples_dropped_total|\
                  prometheus_remote_storage_samples_failed_total|\
                  prometheus_sd_kubernetes_http_request_total|\
                  prometheus_agent_truncate_duration_seconds_sum|\
                  prometheus_build_info|\
                  process_resident_memory_bytes|\
                  process_virtual_memory_bytes|\
                  process_cpu_seconds_total"
                action: keep
          - job_name: homeassistant
            targets:
              - homeassistant.home-automation.svc.cluster.local:8123
            metrics_path: /api/prometheus
            scrape_interval: 60s
            authorization:
              credentials_file: /var/run/secrets/hass.io/token

    # logging:
    #   enabled: true
    # newrelic-logging:
    #   lowDataMode: true
    newrelic-pixie:
      enabled: true
      # apiKey: ""
      customSecretApiKeyName: newrelic
      customSecretApiKeyKey: pixie_apiKey
    pixie-chart:
      enabled: false
      customDeployKeySecret: newrelic # requires key to be 'deploy-key' in the secret
      clusterName: core
# - name: pixie-operator-chart
#   repo: https://pixie-operator-charts.storage.googleapis.com
#   releaseName: pixie
#   namespace: newrelic
#   includeCRDs: true
#   valuesInline:
#     customDeployKeySecret: newrelic
#     clusterName: core
#     pemMemoryLimit: 1Gi

patches:
- target:
    group: px.dev
    version: v1alpha1
    kind: Vizier
    name: pixie
    namespace: newrelic
  patch: |
    - op: remove
      path: /spec/deployKey