version: '3'

env:
  RESTIC_PASSWORD: op://{{.opVault}}/volsync-restic-template/RESTIC_PASSWORD
  AWS_ACCESS_KEY_ID: op://{{.opVault}}/volsync-restic-template/AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY: op://{{.opVault}}/volsync-restic-template/AWS_SECRET_ACCESS_KEY

tasks:
  default:
    silent: true
    requires:
      vars: [repo]
    vars:
      resticBucket:
        sh: op read op://{{.opVault}}/volsync-restic-template/REPOSITORY_TEMPLATE
    cmds:
      - op run -- restic --repo={{.resticBucket}}/{{.repo}} {{.CLI_ARGS | default "-h"}}
      
  snapshots:
    desc: Get snapshots for a specific restic repo
    requires:
      vars: [repo]
    vars:
      resticBucket:
        sh: op read op://{{.opVault}}/volsync-restic-template/REPOSITORY_TEMPLATE
    cmds:
      - op run -- restic snapshots --repo={{.resticBucket}}/{{.repo}}

  restore:
    desc: Restores a snapshot with an id to a specified dest
    requires:
      vars: [repo, id, dest]
    vars:
      resticBucket:
        sh: op read op://{{.opVault}}/volsync-restic-template/REPOSITORY_TEMPLATE
    cmds:
      - op run -- restic restore \
        --repo={{.resticBaseRepo}}/{{.repo}} {{.id}} --target {{.dest}}